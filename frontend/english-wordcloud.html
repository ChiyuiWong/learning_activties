<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <meta name="translate" content="no">
    <title>English Word Cloud - COMP5241 LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- WordCloud2.js Library -->
    <script src="https://cdn.jsdelivr.net/gh/timdream/wordcloud2.js/src/wordcloud2.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
        }
        
        .wordcloud-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }
        
        .wordcloud-canvas {
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .control-panel {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .stats-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: none;
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            color: white;
        }
        
        .word-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .word-item {
            padding: 8px 15px;
            margin: 3px 0;
            border-radius: 25px;
            display: inline-block;
            margin-right: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .word-item.english {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .word-item.chinese {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .word-item:hover {
            transform: scale(1.1);
        }
        
        .no-translate {
            translate: no !important;
        }
        
        .header-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }
    </style>
</head>
<body class="no-translate">
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="header-title display-4 mb-2">English Word Cloud</h1>
                <p class="text-white-50 lead">Real-time visualization of student submissions</p>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <i class="bi bi-cloud text-primary fs-1"></i>
                        <h3 class="mt-2 mb-0" id="total-words">0</h3>
                        <small class="text-muted">Total Words</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <i class="bi bi-translate text-success fs-1"></i>
                        <h3 class="mt-2 mb-0" id="english-words">0</h3>
                        <small class="text-muted">English Words</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <i class="bi bi-chat-text text-info fs-1"></i>
                        <h3 class="mt-2 mb-0" id="chinese-words">0</h3>
                        <small class="text-muted">Chinese Words</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <i class="bi bi-people text-warning fs-1"></i>
                        <h3 class="mt-2 mb-0" id="contributors">0</h3>
                        <small class="text-muted">Contributors</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="row">
            <!-- Word Cloud -->
            <div class="col-lg-8 mb-4">
                <div class="card wordcloud-container">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-cloud"></i> Word Cloud Visualization
                            </h5>
                            <button class="btn refresh-btn btn-sm" onclick="loadWordCloudData()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <canvas id="wordcloud-canvas" class="wordcloud-canvas"></canvas>
                        <div id="loading-indicator" class="text-center py-5">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted">Loading word cloud data...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Control Panel -->
            <div class="col-lg-4">
                <div class="card control-panel">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="bi bi-list-ul"></i> Word List
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">Last updated: <span id="last-update">Never</span></small>
                        </div>
                        
                        <div class="word-list" id="word-list">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-hourglass-split"></i>
                                <p class="mb-0 mt-2">Loading words...</p>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Auto-refresh</small>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                                </div>
                            </div>
                            <small class="text-muted">Updates every 30 seconds</small>
                        </div>
                    </div>
                </div>
                
                <!-- Submit New Word -->
                <div class="card control-panel mt-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="bi bi-plus-circle"></i> Submit Word
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="new-word-input" 
                                   placeholder="Enter a word or phrase..." maxlength="50">
                        </div>
                        <button class="btn btn-primary w-100" onclick="submitNewWord()">
                            <i class="bi bi-send"></i> Submit Word
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const WORDCLOUD_ID = '68f1d0c27a93ac676124ea2d';
        let autoRefreshInterval;
        let currentWords = [];
        
        // Disable browser translation
        document.documentElement.setAttribute('translate', 'no');
        document.documentElement.setAttribute('class', 'notranslate');
        
        // Detect language
        function detectLanguage(text) {
            const englishPattern = /^[a-zA-Z\s\-'\.]+$/;
            return englishPattern.test(text.trim()) ? 'english' : 'chinese';
        }
        
        // Load word cloud data
        async function loadWordCloudData() {
            try {
                console.log('Loading word cloud data...');
                
                const response = await fetch(`/api/learning/wordclouds/${WORDCLOUD_ID}/results`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Word cloud data:', data);
                
                currentWords = data.words || [];
                
                // Update statistics
                updateStatistics();
                
                // Update word list
                updateWordList();
                
                // Render word cloud
                renderWordCloud();
                
                // Update timestamp
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                
                // Hide loading indicator
                document.getElementById('loading-indicator').style.display = 'none';
                
            } catch (error) {
                console.error('Failed to load word cloud data:', error);
                showError(error.message);
            }
        }
        
        // Update statistics
        function updateStatistics() {
            const englishWords = currentWords.filter(w => detectLanguage(w.text) === 'english');
            const chineseWords = currentWords.filter(w => detectLanguage(w.text) === 'chinese');
            
            document.getElementById('total-words').textContent = currentWords.length;
            document.getElementById('english-words').textContent = englishWords.length;
            document.getElementById('chinese-words').textContent = chineseWords.length;
            document.getElementById('contributors').textContent = '5+'; // Placeholder
        }
        
        // Update word list
        function updateWordList() {
            const container = document.getElementById('word-list');
            
            if (currentWords.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox"></i>
                        <p class="mb-0 mt-2">No words submitted yet</p>
                    </div>
                `;
                return;
            }
            
            // Sort by frequency
            const sortedWords = [...currentWords].sort((a, b) => b.value - a.value);
            
            let html = '';
            sortedWords.forEach(word => {
                const lang = detectLanguage(word.text);
                const className = `word-item ${lang} no-translate`;
                
                html += `
                    <span class="${className}" title="${word.text} (${word.value} times)">
                        ${word.text} <small>(${word.value})</small>
                    </span>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Render word cloud using WordCloud2.js
        function renderWordCloud() {
            const canvas = document.getElementById('wordcloud-canvas');
            
            if (currentWords.length === 0) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#6c757d';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No words to display', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Prepare data for WordCloud2.js - format: [word, weight]
            const wordCloudData = currentWords.map(word => [
                word.text,
                Math.max(word.value * 15, 10) // Ensure minimum size
            ]);
            
            // Define color palette for professional look
            const colors = [
                '#8B5CF6', '#A855F7', '#9333EA', // Purple tones
                '#3B82F6', '#2563EB', '#1D4ED8', // Blue tones  
                '#10B981', '#059669', '#047857', // Green tones
                '#F59E0B', '#D97706', '#B45309', // Orange tones
                '#EF4444', '#DC2626', '#B91C1C', // Red tones
                '#6366F1', '#4F46E5', '#4338CA'  // Indigo tones
            ];
            
            // Configure WordCloud2.js for professional appearance
            const options = {
                list: wordCloudData,
                gridSize: Math.round(16 * canvas.width / 1024),
                weightFactor: function(size) {
                    // Dynamic scaling based on canvas size
                    const baseSize = Math.min(canvas.width, canvas.height);
                    return Math.pow(size, 0.6) * baseSize / 800;
                },
                fontFamily: 'Impact, Arial Black, sans-serif',
                fontWeight: 'bold',
                color: function(word, weight, fontSize, distance, theta) {
                    // Assign colors based on word characteristics
                    const lang = detectLanguage(word);
                    if (lang === 'english') {
                        // Use cooler colors for English words
                        const coolColors = ['#8B5CF6', '#3B82F6', '#10B981', '#6366F1'];
                        return coolColors[Math.floor(Math.random() * coolColors.length)];
                    } else {
                        // Use warmer colors for Chinese words
                        const warmColors = ['#F59E0B', '#EF4444', '#EC4899', '#F97316'];
                        return warmColors[Math.floor(Math.random() * warmColors.length)];
                    }
                },
                rotateRatio: 0.4, // 40% of words will be rotated
                rotationSteps: 2,  // Only 0° and 90° rotations
                backgroundColor: 'transparent',
                minSize: 12,
                maxRotation: Math.PI / 2, // 90 degrees
                minRotation: -Math.PI / 2, // -90 degrees
                shuffle: true,
                drawOutOfBound: false,
                shrinkToFit: true,
                ellipticity: 0.65, // Make it more oval-shaped
                hover: function(item, dimension, event) {
                    if (item) {
                        canvas.style.cursor = 'pointer';
                        // Optional: show tooltip
                    } else {
                        canvas.style.cursor = 'default';
                    }
                },
                click: function(item, dimension, event) {
                    if (item) {
                        console.log('Clicked word:', item[0]);
                        // Optional: show word details
                    }
                }
            };
            
            // Clear canvas and render
            try {
                console.log('Rendering word cloud with', wordCloudData.length, 'words');
                
                // Clear the canvas first
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Check if WordCloud function is available
                if (typeof WordCloud === 'undefined') {
                    console.error('WordCloud library not loaded');
                    showError('WordCloud library not available');
                    return;
                }
                
                // Render the word cloud
                WordCloud(canvas, options);
                
                console.log('Word cloud rendered successfully');
                
            } catch (error) {
                console.error('WordCloud rendering error:', error);
                showError('Failed to render word cloud: ' + error.message);
            }
        }
        
        // Submit new word
        async function submitNewWord() {
            const input = document.getElementById('new-word-input');
            const word = input.value.trim();
            
            if (!word) {
                alert('Please enter a word');
                return;
            }
            
            try {
                const response = await fetch(`/api/learning/wordclouds/${WORDCLOUD_ID}/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ word: word })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Word "${word}" submitted successfully!`);
                    input.value = '';
                    // Refresh data after submission
                    setTimeout(loadWordCloudData, 500);
                } else {
                    alert(`Failed to submit word: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`Network error: ${error.message}`);
            }
        }
        
        // Show error
        function showError(message) {
            const container = document.getElementById('wordcloud-canvas');
            container.style.display = 'none';
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-center py-5';
            errorDiv.innerHTML = `
                <div class="text-danger mb-3">
                    <i class="bi bi-exclamation-triangle fs-1"></i>
                </div>
                <h5 class="text-danger">Error Loading Word Cloud</h5>
                <p class="text-muted">${message}</p>
                <button class="btn btn-primary" onclick="loadWordCloudData()">Try Again</button>
            `;
            
            container.parentNode.appendChild(errorDiv);
        }
        
        // Setup auto-refresh
        function setupAutoRefresh() {
            const checkbox = document.getElementById('auto-refresh');
            
            function toggleAutoRefresh() {
                if (checkbox.checked) {
                    autoRefreshInterval = setInterval(loadWordCloudData, 30000);
                } else {
                    clearInterval(autoRefreshInterval);
                }
            }
            
            checkbox.addEventListener('change', toggleAutoRefresh);
            toggleAutoRefresh(); // Initialize
        }
        
        // Enter key submission
        document.getElementById('new-word-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitNewWord();
            }
        });
        
        // Fallback word cloud rendering (if WordCloud2.js fails)
        function renderFallbackWordCloud() {
            const canvas = document.getElementById('wordcloud-canvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (currentWords.length === 0) {
                ctx.fillStyle = '#6c757d';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No words to display', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Simple scattered word layout
            const colors = ['#8B5CF6', '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#EC4899'];
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            currentWords.forEach((word, index) => {
                const lang = detectLanguage(word.text);
                const fontSize = Math.max(12 + word.value * 8, 16);
                const angle = (index * 137.5) * Math.PI / 180; // Golden angle for distribution
                const radius = Math.min(150, 50 + index * 15);
                
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                ctx.save();
                ctx.translate(x, y);
                
                // Random rotation for some words
                if (Math.random() > 0.6) {
                    ctx.rotate((Math.random() - 0.5) * Math.PI / 2);
                }
                
                ctx.font = `bold ${fontSize}px Impact, Arial Black, sans-serif`;
                ctx.fillStyle = lang === 'english' ? colors[index % 3] : colors[3 + (index % 3)];
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Add text shadow for better visibility
                ctx.shadowColor = 'rgba(0,0,0,0.3)';
                ctx.shadowBlur = 2;
                ctx.shadowOffsetX = 1;
                ctx.shadowOffsetY = 1;
                
                ctx.fillText(word.text, 0, 0);
                ctx.restore();
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing word cloud...');
            
            // Resize canvas to fit container
            const canvas = document.getElementById('wordcloud-canvas');
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = 500;
            
            // Check if WordCloud2.js is loaded
            setTimeout(() => {
                if (typeof WordCloud === 'undefined') {
                    console.warn('WordCloud2.js not loaded, using fallback renderer');
                    // Override the render function to use fallback
                    window.renderWordCloud = renderFallbackWordCloud;
                }
            }, 1000);
            
            // Load initial data
            loadWordCloudData();
            
            // Setup auto-refresh
            setupAutoRefresh();
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            const canvas = document.getElementById('wordcloud-canvas');
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = 500;
            
            // Re-render word cloud
            if (currentWords.length > 0) {
                renderWordCloud();
            }
        });
    </script>
</body>
</html>
