<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Creation Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="static/css/notifications.css">
    <link rel="stylesheet" href="static/css/quiz.css">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Quiz Creation</h1>
            <a href="index.html" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
        
        <div class="card mt-4 mb-5">
            <div class="card-header bg-primary text-white">
                <h2>Create Quiz</h2>
            </div>
            <div class="card-body">
                <form id="quiz-test-form">
                    <!-- Basic Info -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2">Basic Information</h5>
                        <div class="mb-3">
                            <label class="form-label">Title*</label>
                            <input type="text" class="form-control" name="title" value="Sample Quiz" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description">This is a test quiz created to verify the quiz creation functionality.</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Course ID</label>
                            <select class="form-select" name="course_id">
                                <option value="COMP5241">COMP5241 - Advanced Software Engineering</option>
                                <option value="COMP5322">COMP5322 - Internet Infrastructure</option>
                                <option value="COMP5521">COMP5521 - Advanced Database Systems</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Instructions for Students</label>
                            <textarea class="form-control" name="instructions">Please answer all questions to the best of your knowledge. You may review your answers before submission.</textarea>
                        </div>
                    </div>
                    
                    <!-- Quiz Settings -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2">Quiz Settings</h5>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Time Limit (minutes)</label>
                                    <input type="number" class="form-control" name="time_limit" min="0" value="15">
                                    <div class="form-text">Set to 0 for no time limit</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Passing Score (%)</label>
                                    <input type="number" class="form-control" name="passing_score" min="0" max="100" value="60">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Maximum Score</label>
                                    <input type="number" class="form-control" name="max_score" min="1" value="100">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="shuffle_questions" name="shuffle_questions">
                                    <label class="form-check-label" for="shuffle_questions">Shuffle Questions</label>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="show_results" name="show_results" checked>
                                    <label class="form-check-label" for="show_results">Show Results Immediately</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="allow_retries" name="allow_retries">
                                    <label class="form-check-label" for="allow_retries">Allow Multiple Attempts</label>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="show_explanations" name="show_explanations" checked>
                                    <label class="form-check-label" for="show_explanations">Show Answer Explanations</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Expiration Date (optional)</label>
                            <input type="datetime-local" class="form-control" name="expires_at">
                            <div class="form-text">Leave blank if the quiz doesn't expire</div>
                        </div>
                    </div>
                    
                    <!-- Quiz Questions -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2">Questions</h5>
                        <div id="quiz-questions">
                            <!-- Questions will be added here -->
                        </div>
                        <button type="button" id="add-question-btn" class="btn btn-outline-primary mt-3">
                            <i class="bi bi-plus-circle"></i> Add Question
                        </button>
                    </div>
                    
                    <!-- Quiz Summary -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2">Quiz Summary</h5>
                        <div class="p-3 bg-light rounded">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Total Questions:</strong> <span id="summary-question-count">0</span></p>
                                    <p><strong>Total Points:</strong> <span id="summary-points">0</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Question Types:</strong></p>
                                    <ul id="summary-question-types">
                                        <!-- Question type counts will be populated here -->
                                    </ul>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="updateQuizSummary()">
                                <i class="bi bi-arrow-repeat"></i> Update Summary
                            </button>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="confirmSubmit()">Create Quiz</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='index.html'">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Preview Modal -->
        <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="previewModalLabel">Quiz Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="preview-content">
                        <!-- Preview content will be generated here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('quiz-test-form').submit()">
                            Create Quiz
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h3>API Response</h3>
            </div>
            <div class="card-body">
                <pre id="response" class="bg-light p-3"></pre>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="static/js/auth-helpers.js"></script>
    <script src="static/js/api.js"></script>
    <script>
        // Question counter
        let questionCounter = 0;
        
        // Add a question when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!checkAuth()) {
                window.location.href = 'login.html';
                return;
            }
            
            addQuestion();
            
            // Add event listener for form submission
            document.getElementById('quiz-test-form').addEventListener('submit', function(e) {
                e.preventDefault();
                submitQuiz();
            });
            
            // Add event listener for adding questions
            document.getElementById('add-question-btn').addEventListener('click', function() {
                addQuestion();
                updateQuizSummary();
            });
            
            // Initial summary update
            updateQuizSummary();
        });
        
        function updateQuizSummary() {
            const form = document.getElementById('quiz-test-form');
            const questionDivs = form.querySelectorAll('.quiz-question');
            const questionTypes = {};
            let totalPoints = 0;
            
            // Count question types and calculate points
            questionDivs.forEach(div => {
                const typeSelect = div.querySelector('select[name$=".type"]');
                const type = typeSelect ? typeSelect.value : 'multiple_choice';
                const pointsInput = div.querySelector('input[name$=".points"]');
                const points = pointsInput ? parseInt(pointsInput.value) || 1 : 1;
                
                // Update type counts
                questionTypes[type] = (questionTypes[type] || 0) + 1;
                
                // Add to total points
                totalPoints += points;
            });
            
            // Update summary in the UI
            document.getElementById('summary-question-count').textContent = questionDivs.length;
            document.getElementById('summary-points').textContent = totalPoints;
            
            // Update question type list
            const typesList = document.getElementById('summary-question-types');
            typesList.innerHTML = '';
            
            const typeLabels = {
                'multiple_choice': 'Multiple Choice',
                'true_false': 'True/False',
                'text_entry': 'Text Entry',
                'matching': 'Matching'
            };
            
            for (const type in questionTypes) {
                const label = typeLabels[type] || type;
                const li = document.createElement('li');
                li.textContent = `${label}: ${questionTypes[type]}`;
                typesList.appendChild(li);
            }
        }
        
        function confirmSubmit() {
            // Show preview modal with quiz content
            generatePreview();
            
            // Show the modal
            const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
            previewModal.show();
        }
        
        function generatePreview() {
            const form = document.getElementById('quiz-test-form');
            const formData = new FormData(form);
            
            // Basic quiz info
            const title = formData.get('title');
            const description = formData.get('description');
            const instructions = formData.get('instructions');
            const timeLimit = formData.get('time_limit') ? parseInt(formData.get('time_limit')) : 0;
            
            // Get questions preview
            const questions = processQuizQuestions(form);
            
            // Generate HTML preview
            let previewHtml = `
                <div class="quiz-preview">
                    <h4>${title}</h4>
                    <p class="text-muted mb-3">${description}</p>
                    
                    <div class="alert alert-info">
                        <strong>Instructions:</strong> ${instructions}
                    </div>
                    
                    <div class="mb-4">
                        <span class="badge bg-secondary me-2">${timeLimit} minutes</span>
                        <span class="badge bg-secondary me-2">${questions.length} questions</span>
                        <span class="badge bg-secondary me-2">${formData.get('max_score')} points</span>
                    </div>
                    
                    <h5>Questions</h5>
                    <div class="questions-preview">
            `;
            
            // Add questions to preview
            questions.forEach((question, index) => {
                previewHtml += `
                    <div class="card mb-3">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <span>Question ${index + 1} (${question.points} point${question.points > 1 ? 's' : ''})</span>
                            <span class="badge bg-primary">${formatQuestionType(question.question_type)}</span>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">${question.text}</p>
                `;
                
                // Add options based on question type
                switch (question.question_type) {
                    case 'multiple_choice':
                    case 'true_false':
                        previewHtml += '<ul class="list-group">';
                        question.options.forEach((option) => {
                            previewHtml += `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${option.text}
                                    ${option.is_correct ? '<span class="badge bg-success">Correct</span>' : ''}
                                </li>
                            `;
                        });
                        previewHtml += '</ul>';
                        break;
                        
                    case 'text_entry':
                        previewHtml += `
                            <div class="alert alert-secondary">
                                <strong>Correct Answer:</strong> ${question.options[0]?.text}
                                ${question.options[0]?.case_sensitive ? ' <span class="badge bg-warning text-dark">Case Sensitive</span>' : ''}
                            </div>
                        `;
                        break;
                        
                    case 'matching':
                        previewHtml += '<table class="table">';
                        previewHtml += '<tr><th>Left Item</th><th></th><th>Right Item</th></tr>';
                        question.options.forEach((pair) => {
                            previewHtml += `
                                <tr>
                                    <td>${pair.left}</td>
                                    <td><i class="bi bi-arrow-right"></i></td>
                                    <td>${pair.right}</td>
                                </tr>
                            `;
                        });
                        previewHtml += '</table>';
                        break;
                }
                
                // Add explanation if present
                if (question.explanation) {
                    previewHtml += `
                        <div class="mt-3">
                            <p><strong>Explanation:</strong> ${question.explanation}</p>
                        </div>
                    `;
                }
                
                previewHtml += `
                        </div>
                    </div>
                `;
            });
            
            previewHtml += `
                    </div>
                </div>
            `;
            
            // Set the preview content
            document.getElementById('preview-content').innerHTML = previewHtml;
        }
        
        function formatQuestionType(type) {
            const typeLabels = {
                'multiple_choice': 'Multiple Choice',
                'true_false': 'True/False',
                'text_entry': 'Text Entry',
                'matching': 'Matching'
            };
            
            return typeLabels[type] || type;
        }
        
        function addQuestion() {
            const container = document.getElementById('quiz-questions');
            const questionNum = questionCounter + 1;
            
            const questionHtml = `
                <div class="quiz-question card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Question ${questionNum}</h6>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(this)">
                                <i class="bi bi-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Question Text*</label>
                            <textarea class="form-control" name="questions[${questionCounter}].text" required 
                                   placeholder="Enter your question here..."></textarea>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">Question Type</label>
                                <select class="form-select question-type-select" name="questions[${questionCounter}].type" 
                                        onchange="handleQuestionTypeChange(this)">
                                    <option value="multiple_choice">Multiple Choice</option>
                                    <option value="true_false">True/False</option>
                                    <option value="text_entry">Text Entry</option>
                                    <option value="matching">Matching</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Points</label>
                                <input type="number" class="form-control" name="questions[${questionCounter}].points" min="1" value="1">
                            </div>
                        </div>
                        
                        <div class="options-container">
                            <p class="fw-medium mb-2">Options <small class="text-muted">(select the correct answer)</small></p>
                            <div class="option-group mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input type="radio" name="questions[${questionCounter}].correct" value="0" checked>
                                    </div>
                                    <input type="text" class="form-control" name="questions[${questionCounter}].options[0]" 
                                           placeholder="Option 1" required>
                                </div>
                            </div>
                            <div class="option-group mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input type="radio" name="questions[${questionCounter}].correct" value="1">
                                    </div>
                                    <input type="text" class="form-control" name="questions[${questionCounter}].options[1]" 
                                           placeholder="Option 2" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 mb-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" 
                                    onclick="addOption(this)">
                                <i class="bi bi-plus-circle"></i> Add Option
                            </button>
                        </div>
                        
                        <div class="mb-3 mt-4">
                            <label class="form-label">Explanation (Optional)</label>
                            <textarea class="form-control" name="questions[${questionCounter}].explanation" 
                                      placeholder="Explanation to show after answering..."></textarea>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', questionHtml);
            
            // Add animation class to the new question
            const newQuestion = container.lastElementChild;
            newQuestion.classList.add('just-added');
            setTimeout(() => newQuestion.classList.remove('just-added'), 1000);
            
            questionCounter++;
        }
        
        function removeQuestion(button) {
            const questionDiv = button.closest('.quiz-question');
            
            // Apply removing animation
            questionDiv.classList.add('removing');
            
            // Wait for animation to complete before removing
            setTimeout(() => {
                questionDiv.remove();
            }, 300);
        }
        
        function addOption(button) {
            const questionDiv = button.closest('.quiz-question');
            const optionsContainer = questionDiv.querySelector('.options-container');
            
            // Find the correct question index from naming scheme
            const nameInput = questionDiv.querySelector('[name$=".text"]');
            const namePrefix = nameInput.name.split('.')[0];
            const optionCount = optionsContainer.querySelectorAll('.option-group').length;
            
            const optionHtml = `
                <div class="option-group mb-2">
                    <div class="input-group">
                        <div class="input-group-text">
                            <input type="radio" name="${namePrefix}.correct" value="${optionCount}">
                        </div>
                        <input type="text" class="form-control" name="${namePrefix}.options[${optionCount}]" 
                               placeholder="Option ${optionCount + 1}" required>
                        <button type="button" class="btn btn-outline-danger" 
                                onclick="this.closest('.option-group').remove()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            optionsContainer.insertAdjacentHTML('beforeend', optionHtml);
            
            // Add animation class to the new option
            const newOption = optionsContainer.lastElementChild;
            newOption.classList.add('just-added');
            setTimeout(() => newOption.classList.remove('just-added'), 1000);
        }
        
        function handleQuestionTypeChange(selectElement) {
            const questionDiv = selectElement.closest('.quiz-question');
            const optionsContainer = questionDiv.querySelector('.options-container');
            const questionType = selectElement.value;
            const questionIndex = Array.from(questionDiv.parentNode.children).indexOf(questionDiv);
            const addOptionBtn = questionDiv.querySelector('button[onclick*="addOption"]');
            
            switch(questionType) {
                case 'true_false':
                    // For True/False questions, we provide fixed options
                    optionsContainer.innerHTML = `
                        <p class="fw-medium mb-2">Options <small class="text-muted">(select the correct answer)</small></p>
                        <div class="option-group mb-2">
                            <div class="input-group">
                                <div class="input-group-text">
                                    <input type="radio" name="questions[${questionIndex}].correct" value="0" checked>
                                </div>
                                <input type="text" class="form-control" name="questions[${questionIndex}].options[0]" 
                                       value="True" readonly>
                            </div>
                        </div>
                        <div class="option-group mb-2">
                            <div class="input-group">
                                <div class="input-group-text">
                                    <input type="radio" name="questions[${questionIndex}].correct" value="1">
                                </div>
                                <input type="text" class="form-control" name="questions[${questionIndex}].options[1]" 
                                       value="False" readonly>
                            </div>
                        </div>
                    `;
                    
                    // Hide the add option button
                    if (addOptionBtn) {
                        addOptionBtn.style.display = 'none';
                    }
                    break;
                    
                case 'multiple_choice':
                    // Show the add option button
                    if (addOptionBtn) {
                        addOptionBtn.style.display = '';
                    }
                    
                    // Check if we need to reset from another type
                    if (optionsContainer.querySelectorAll('.option-group').length < 2) {
                        // Reset to default state with two options
                        optionsContainer.innerHTML = `
                            <p class="fw-medium mb-2">Options <small class="text-muted">(select the correct answer)</small></p>
                            <div class="option-group mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input type="radio" name="questions[${questionIndex}].correct" value="0" checked>
                                    </div>
                                    <input type="text" class="form-control" name="questions[${questionIndex}].options[0]" 
                                           placeholder="Option 1" required>
                                </div>
                            </div>
                            <div class="option-group mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input type="radio" name="questions[${questionIndex}].correct" value="1">
                                    </div>
                                    <input type="text" class="form-control" name="questions[${questionIndex}].options[1]" 
                                           placeholder="Option 2" required>
                                </div>
                            </div>
                        `;
                    }
                    break;
                    
                case 'text_entry':
                    // Text entry question - just a text field for answer
                    optionsContainer.innerHTML = `
                        <p class="fw-medium mb-2">Correct Answer</p>
                        <div class="option-group mb-2">
                            <div class="input-group">
                                <input type="text" class="form-control" name="questions[${questionIndex}].options[0]" 
                                       placeholder="Correct answer" required>
                                <div class="input-group-text">
                                    <input type="hidden" name="questions[${questionIndex}].correct" value="0">
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                </div>
                            </div>
                        </div>
                        <div class="form-text mb-3">For text entry questions, students will type their answer, which will be matched against the correct answer.</div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="case_sensitive_${questionIndex}" 
                                   name="questions[${questionIndex}].case_sensitive">
                            <label class="form-check-label" for="case_sensitive_${questionIndex}">Case sensitive matching</label>
                        </div>
                    `;
                    
                    // Hide the add option button
                    if (addOptionBtn) {
                        addOptionBtn.style.display = 'none';
                    }
                    break;
                    
                case 'matching':
                    // Matching questions - pairs of items to match
                    optionsContainer.innerHTML = `
                        <p class="fw-medium mb-2">Matching Pairs</p>
                        <div class="option-group mb-2">
                            <div class="input-group">
                                <span class="input-group-text bg-light">Pair 1</span>
                                <input type="text" class="form-control" name="questions[${questionIndex}].options[0].left" 
                                       placeholder="Left item" required>
                                <span class="input-group-text"><i class="bi bi-arrow-right"></i></span>
                                <input type="text" class="form-control" name="questions[${questionIndex}].options[0].right" 
                                       placeholder="Right item" required>
                            </div>
                        </div>
                        <div class="option-group mb-2">
                            <div class="input-group">
                                <span class="input-group-text bg-light">Pair 2</span>
                                <input type="text" class="form-control" name="questions[${questionIndex}].options[1].left" 
                                       placeholder="Left item" required>
                                <span class="input-group-text"><i class="bi bi-arrow-right"></i></span>
                                <input type="text" class="form-control" name="questions[${questionIndex}].options[1].right" 
                                       placeholder="Right item" required>
                            </div>
                        </div>
                        <input type="hidden" name="questions[${questionIndex}].correct" value="all">
                    `;
                    
                    // Replace the add option button with matching-specific button
                    if (addOptionBtn) {
                        addOptionBtn.outerHTML = `
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-3" 
                                    onclick="addMatchingPair(this)">
                                <i class="bi bi-plus-circle"></i> Add Pair
                            </button>
                        `;
                    }
                    break;
            }
        }
        
        // Helper function for matching questions
        function addMatchingPair(button) {
            const questionDiv = button.closest('.quiz-question');
            const optionsContainer = questionDiv.querySelector('.options-container');
            const questionIndex = Array.from(questionDiv.parentNode.children).indexOf(questionDiv);
            const pairCount = optionsContainer.querySelectorAll('.option-group').length;
            
            const pairHtml = `
                <div class="option-group mb-2">
                    <div class="input-group">
                        <span class="input-group-text bg-light">Pair ${pairCount + 1}</span>
                        <input type="text" class="form-control" name="questions[${questionIndex}].options[${pairCount}].left" 
                               placeholder="Left item" required>
                        <span class="input-group-text"><i class="bi bi-arrow-right"></i></span>
                        <input type="text" class="form-control" name="questions[${questionIndex}].options[${pairCount}].right" 
                               placeholder="Right item" required>
                        <button type="button" class="btn btn-outline-danger" 
                                onclick="this.closest('.option-group').remove()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            optionsContainer.insertAdjacentHTML('beforeend', pairHtml);
            
            // Add animation class
            const newOption = optionsContainer.lastElementChild;
            newOption.classList.add('just-added');
            setTimeout(() => newOption.classList.remove('just-added'), 1000);
        }
        
        function submitQuiz() {
            const form = document.getElementById('quiz-test-form');
            const formData = new FormData(form);
            
            // Convert time limit to seconds
            const timeLimit = formData.get('time_limit') ? parseInt(formData.get('time_limit')) * 60 : null;
            
            // Get expiration date or null if not set
            let expiresAt = formData.get('expires_at') || null;
            
            // Format the date correctly for API
            if (expiresAt) {
                expiresAt = new Date(expiresAt).toISOString();
            }
            
            const data = {
                title: formData.get('title'),
                description: formData.get('description'),
                activity_type: 'quiz',
                course_id: formData.get('course_id'),
                instructions: formData.get('instructions'),
                max_score: parseInt(formData.get('max_score') || 100),
                time_limit: timeLimit,
                due_date: expiresAt,
                metadata: {
                    shuffle_questions: document.getElementById('shuffle_questions').checked,
                    passing_score: parseInt(formData.get('passing_score') || 60),
                    show_results: document.getElementById('show_results').checked,
                    allow_retries: document.getElementById('allow_retries').checked,
                    show_explanations: document.getElementById('show_explanations').checked,
                    questions: processQuizQuestions(form),
                }
            };
            
            // Display data being sent
            document.getElementById('response').textContent = 'Sending request...\n\n' + 
                JSON.stringify(data, null, 2);
            
            // Initialize API client
            const api = new APIClient('http://localhost:5001');
            
            // Send to API
            api.post('/api/learning/quizzes/', data)
            .then(result => {
                document.getElementById('response').textContent = JSON.stringify(result, null, 2);
                if (result.success || result.message) {
                    showNotification('Quiz created successfully!', 'success');
                    
                    // Clear form or redirect after success
                    if (confirm('Quiz created successfully! Create another quiz?')) {
                        // Reset form but keep course selection
                        const selectedCourse = formData.get('course_id');
                        form.reset();
                        document.querySelector('select[name="course_id"]').value = selectedCourse;
                        
                        // Add a default question
                        const questionsContainer = document.getElementById('quiz-questions');
                        questionsContainer.innerHTML = '';
                        questionCounter = 0;
                        addQuestion();
                    } else {
                        // Redirect back to the activities page
                        window.location.href = 'index.html';
                    }
                } else {
                    showNotification('Failed to create quiz: ' + (result.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                document.getElementById('response').textContent = 'Error: ' + error.message;
                showNotification('Error: ' + error.message, 'danger');
            });
        }
        
        function processQuizQuestions(form) {
            const questions = [];
            const questionDivs = form.querySelectorAll('.quiz-question');
            
            questionDivs.forEach((div, index) => {
                // Find the actual index in the form's naming scheme
                const namePrefix = div.querySelector('[name$=".text"]').name.split('.')[0];
                
                // Get question type from select
                const questionTypeSelect = div.querySelector(`select[name="${namePrefix}.type"]`);
                const questionType = questionTypeSelect ? questionTypeSelect.value : 'multiple_choice';
                
                // Get explanation if it exists
                const explanationField = div.querySelector(`textarea[name="${namePrefix}.explanation"]`);
                const explanation = explanationField ? explanationField.value : '';
                
                // Get points value
                const pointsInput = div.querySelector(`input[name="${namePrefix}.points"]`);
                const points = pointsInput ? parseInt(pointsInput.value) || 1 : 1;
                
                // Get question text (could be input or textarea)
                const textElement = div.querySelector(`[name="${namePrefix}.text"]`);
                const questionText = textElement ? textElement.value : '';
                
                let options = [];
                
                // Process options based on question type
                switch(questionType) {
                    case 'multiple_choice':
                    case 'true_false':
                        const optionInputs = div.querySelectorAll(`input[name^="${namePrefix}.options"][name$="]"]`);
                        const correctOption = div.querySelector(`input[name="${namePrefix}.correct"]:checked`)?.value || '0';
                        
                        optionInputs.forEach((input, optIndex) => {
                            options.push({
                                text: input.value,
                                is_correct: optIndex.toString() === correctOption,
                            });
                        });
                        break;
                        
                    case 'text_entry':
                        const correctAnswer = div.querySelector(`input[name^="${namePrefix}.options"]`).value;
                        const caseSensitive = div.querySelector(`input[id^="case_sensitive_"]`)?.checked || false;
                        
                        options = [{
                            text: correctAnswer,
                            is_correct: true,
                            case_sensitive: caseSensitive
                        }];
                        break;
                        
                    case 'matching':
                        // For matching, we need to process pairs
                        const leftInputs = div.querySelectorAll(`input[name$=".left"]`);
                        const rightInputs = div.querySelectorAll(`input[name$=".right"]`);
                        
                        for(let i = 0; i < leftInputs.length; i++) {
                            if(leftInputs[i].value && rightInputs[i].value) {
                                options.push({
                                    left: leftInputs[i].value,
                                    right: rightInputs[i].value,
                                    is_correct: true // All pairs are correct by definition
                                });
                            }
                        }
                        break;
                }
                
                questions.push({
                    text: questionText,
                    options: options,
                    points: points,
                    question_type: questionType,
                    explanation: explanation
                });
            });
            
            return questions;
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `alert alert-${type} notification-toast`;
            notificationDiv.innerHTML = message;
            
            // Add to document
            document.body.appendChild(notificationDiv);
            
            // Add visible class for animation
            setTimeout(() => notificationDiv.classList.add('visible'), 10);
            
            // Remove after delay
            setTimeout(() => {
                notificationDiv.classList.remove('visible');
                setTimeout(() => notificationDiv.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>