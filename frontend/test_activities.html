<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Creation Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Server Status Indicator -->
    <style>
        .server-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .status-online {
            background-color: #d4f7d4;
            color: #0a6b0a;
            border: 1px solid #0a6b0a;
        }
        .status-offline {
            background-color: #f7d4d4;
            color: #6b0a0a;
            border: 1px solid #6b0a0a;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .indicator-online {
            background-color: #0a6b0a;
        }
        .indicator-offline {
            background-color: #6b0a0a;
        }
    </style>
</head>
<body>
    <!-- Server Status Indicator -->
    <div id="server-status" class="server-status">
        <span class="status-indicator" id="status-indicator"></span>
        <span id="status-text">Checking server...</span>
    </div>
    
    <div class="container mt-5">
        <h1>Test Activity Creation</h1>
        
        <div class="card mt-4">
            <div class="card-header">
                <h2>Create Poll</h2>
            </div>
            <div class="card-body">
                <form id="poll-form">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="poll-title" value="Test Poll">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="poll-description" value="A test poll description">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Question</label>
                        <input type="text" class="form-control" id="poll-question" value="What is your favorite color?">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Options (comma separated)</label>
                        <input type="text" class="form-control" id="poll-options" value="Red, Blue, Green, Yellow">
                    </div>
                    <button type="submit" class="btn btn-primary">Create Poll</button>
                </form>
                <div class="mt-3">
                    <pre id="response" class="bg-light p-3"></pre>
                </div>
            </div>
        </div>
    </div>
    
    <script src="static/js/api.js"></script>
    <script>
        // Initialize API client
        const api = new APIClient('http://localhost:5001');
        
        // Check server status
        function checkServerStatus() {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const statusContainer = document.getElementById('server-status');
            
            fetch('http://localhost:5001/api/health')
                .then(response => {
                    if (response.ok) {
                        statusIndicator.className = 'status-indicator indicator-online';
                        statusText.textContent = 'Server Online';
                        statusContainer.className = 'server-status status-online';
                    } else {
                        statusIndicator.className = 'status-indicator indicator-offline';
                        statusText.textContent = 'Server Error';
                        statusContainer.className = 'server-status status-offline';
                    }
                })
                .catch(error => {
                    console.error('Server status check failed:', error);
                    statusIndicator.className = 'status-indicator indicator-offline';
                    statusText.textContent = 'Server Offline';
                    statusContainer.className = 'server-status status-offline';
                });
        }
        
        // Check server status immediately and every 10 seconds
        checkServerStatus();
        setInterval(checkServerStatus, 10000);
        
        document.getElementById('poll-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('poll-title').value;
            const description = document.getElementById('poll-description').value;
            const question = document.getElementById('poll-question').value;
            const options = document.getElementById('poll-options').value.split(',').map(opt => opt.trim());
            
            const responseEl = document.getElementById('response');
            responseEl.textContent = 'Sending request...';
            
            try {
                const response = await fetch('http://localhost:5001/api/learning/activities/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        activity_type: 'poll',
                        course_id: 'COMP5241',
                        instructions: 'Please answer this poll',
                        metadata: {
                            question: question,
                            options: options,
                            is_anonymous: true
                        }
                    })
                });
                
                const data = await response.json();
                responseEl.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                responseEl.textContent = 'Error: ' + error.message;
            }
        });
        
        // Add /api prefix to endpoints if needed - patch the fetch API
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            // If URL is a string and it's for our API but missing the /api prefix
            if (typeof url === 'string' && url.includes('localhost:5001/')) {
                // Add /api prefix to endpoints if needed
                if (url.includes('/learning/') && !url.includes('/api/learning/')) {
                    url = url.replace('/learning/', '/api/learning/');
                    console.log('API endpoint patched to:', url);
                }
                
                // Fix for health check endpoint
                if (url.includes('/health') && !url.includes('/api/health')) {
                    url = url.replace('/health', '/api/health');
                    console.log('API endpoint patched to:', url);
                }
                
                // Fix for security endpoints
                if (url.includes('/security/') && !url.includes('/api/security/')) {
                    url = url.replace('/security/', '/api/security/');
                    console.log('API endpoint patched to:', url);
                }
                
                // Fix the quiz typo (quizs -> quizzes)
                if (url.includes('/learning/quizs/') || url.includes('/api/learning/quizs/')) {
                    url = url.replace('quizs', 'quizzes');
                    console.log('Quiz endpoint fixed:', url);
                }
            }
            
            return originalFetch.call(this, url, options);
        };
    </script>
</body>
</html>