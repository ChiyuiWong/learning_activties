<!DOCTYPE html>
<html>
<head>
    <title>ç´§æ€¥ä¿®å¤ - æ•™å¸ˆç™»å½•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .step { margin: 15px 0; padding: 15px; border: 2px solid #ddd; border-radius: 5px; }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        button { margin: 5px; padding: 12px 20px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¨ ç´§æ€¥ä¿®å¤ - æ•™å¸ˆç™»å½•é—®é¢˜</h1>
        
        <div class="step warning">
            <h3>âš ï¸ é—®é¢˜è¯Šæ–­</h3>
            <p>æ‚¨å·²ç»ç™»å½•äº†ï¼Œä½†æ˜¯æ•™å¸ˆé¡µé¢ä»ç„¶è¦æ±‚ç™»å½•ã€‚è¿™é€šå¸¸æ˜¯å› ä¸ºï¼š</p>
            <ul>
                <li>JWT tokenæ²¡æœ‰æ­£ç¡®ä¿å­˜åˆ°localStorage</li>
                <li>APIè¯·æ±‚æ²¡æœ‰åŒ…å«Authorizationå¤´</li>
                <li>æµè§ˆå™¨ç¼“å­˜äº†æ—§çš„JavaScriptæ–‡ä»¶</li>
            </ul>
        </div>

        <div class="step">
            <h3>ğŸ”§ æ­¥éª¤1: å®Œå…¨é‡ç½®</h3>
            <button class="btn-danger" onclick="completeReset()">å®Œå…¨é‡ç½®ï¼ˆæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼‰</button>
            <div id="resetResult"></div>
        </div>

        <div class="step">
            <h3>ğŸ”‘ æ­¥éª¤2: é‡æ–°ç™»å½•</h3>
            <button class="btn-success" onclick="emergencyLogin()">ç´§æ€¥ç™»å½•ï¼ˆä½¿ç”¨å†…ç½®APIï¼‰</button>
            <div id="loginResult"></div>
        </div>

        <div class="step">
            <h3>ğŸ§ª æ­¥éª¤3: æµ‹è¯•éªŒè¯</h3>
            <button class="btn-primary" onclick="testEverything()">å…¨é¢æµ‹è¯•</button>
            <div id="testResult"></div>
        </div>

        <div class="step">
            <h3>ğŸ¯ æ­¥éª¤4: è®¿é—®æ•™å¸ˆé¡µé¢</h3>
            <button class="btn-warning" onclick="openTeacherPage()">æ‰“å¼€æ•™å¸ˆç®¡ç†é¡µé¢</button>
            <div id="accessResult"></div>
        </div>

        <div class="step">
            <h3>ğŸ“‹ å®æ—¶æ—¥å¿—</h3>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script>
        // å†…ç½®APIå®¢æˆ·ç«¯ï¼Œä¸ä¾èµ–å¤–éƒ¨æ–‡ä»¶
        class EmergencyAPI {
            constructor() {
                this.baseUrl = window.location.protocol + '//' + window.location.host;
                this.log('EmergencyAPI initialized');
            }
            
            log(message) {
                const logDiv = document.getElementById('debugLog');
                const timestamp = new Date().toLocaleTimeString();
                logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;
                console.log(message);
            }
            
            getHeaders() {
                const headers = { 'Content-Type': 'application/json' };
                const token = localStorage.getItem('access_token');
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                    this.log('âœ… JWT token added to headers');
                } else {
                    this.log('âŒ No JWT token found');
                }
                return headers;
            }
            
            async request(endpoint, options = {}) {
                const url = `${this.baseUrl}/api${endpoint}`;
                const config = {
                    headers: this.getHeaders(),
                    ...options
                };
                
                this.log(`Making request to: ${url}`);
                this.log(`Headers: ${JSON.stringify(config.headers)}`);
                
                try {
                    const response = await fetch(url, config);
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(`${response.status}: ${data.message || 'Request failed'}`);
                    }
                    
                    this.log(`âœ… Request successful: ${response.status}`);
                    return data;
                } catch (error) {
                    this.log(`âŒ Request failed: ${error.message}`);
                    throw error;
                }
            }
            
            async post(endpoint, body) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(body)
                });
            }
            
            async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            }
        }
        
        const api = new EmergencyAPI();
        
        function completeReset() {
            // æ¸…ç©ºæ‰€æœ‰å­˜å‚¨
            localStorage.clear();
            sessionStorage.clear();
            
            // å°è¯•æ¸…ç©ºcookies
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            
            // æ¸…ç©ºç¼“å­˜ï¼ˆå°½åŠ›è€Œä¸ºï¼‰
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(name) {
                        caches.delete(name);
                    });
                });
            }
            
            api.log('ğŸ—‘ï¸ Complete reset performed');
            document.getElementById('resetResult').innerHTML = 
                '<div class="success">âœ… å·²å®Œå…¨é‡ç½®æ‰€æœ‰æ•°æ®å’Œç¼“å­˜</div>';
        }
        
        async function emergencyLogin() {
            try {
                api.log('ğŸ”‘ Starting emergency login...');
                
                const response = await api.post('/security/login', {
                    username: 'teacher1',
                    password: 'password123'
                });
                
                api.log(`Login response: ${JSON.stringify(response)}`);
                
                // ä¿å­˜ç™»å½•ä¿¡æ¯
                localStorage.setItem('access_token', response.access_token);
                localStorage.setItem('username', response.username);
                localStorage.setItem('user_role', response.role);
                localStorage.setItem('user_name', response.name);
                
                api.log('âœ… Login successful, tokens saved');
                document.getElementById('loginResult').innerHTML = 
                    '<div class="success">âœ… ç´§æ€¥ç™»å½•æˆåŠŸï¼Tokenå·²ä¿å­˜</div>';
                
            } catch (error) {
                api.log(`âŒ Emergency login failed: ${error.message}`);
                document.getElementById('loginResult').innerHTML = 
                    '<div class="error">âŒ ç´§æ€¥ç™»å½•å¤±è´¥: ' + error.message + '</div>';
            }
        }
        
        async function testEverything() {
            const results = [];
            
            // æ£€æŸ¥å­˜å‚¨
            const token = localStorage.getItem('access_token');
            const username = localStorage.getItem('username');
            const role = localStorage.getItem('user_role');
            
            results.push(`Token: ${token ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±'}`);
            results.push(`Username: ${username || 'âŒ ç¼ºå¤±'}`);
            results.push(`Role: ${role || 'âŒ ç¼ºå¤±'}`);
            
            // æµ‹è¯•API
            try {
                const polls = await api.get('/learning/polls/?course_id=COMP5241');
                results.push(`âœ… APIæµ‹è¯•æˆåŠŸï¼Œè¿”å›${polls.length}ä¸ªæŠ•ç¥¨`);
            } catch (error) {
                results.push(`âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}`);
            }
            
            document.getElementById('testResult').innerHTML = 
                '<div class="' + (results.some(r => r.includes('âŒ')) ? 'error' : 'success') + '">' +
                results.join('<br>') + '</div>';
        }
        
        function openTeacherPage() {
            api.log('ğŸ¯ Opening teacher page...');
            window.open('teacher-activities.html', '_blank');
            document.getElementById('accessResult').innerHTML = 
                '<div class="warning">ğŸ“š æ•™å¸ˆé¡µé¢å·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æ­£å¸¸æ˜¾ç¤º</div>';
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', function() {
            api.log('ğŸ“‹ Emergency fix page loaded');
            
            const token = localStorage.getItem('access_token');
            if (token) {
                api.log('ğŸ” Found existing token, testing...');
                testEverything();
            } else {
                api.log('âš ï¸ No token found, please complete reset and login');
            }
        });
    </script>
</body>
</html>
