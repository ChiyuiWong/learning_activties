<!DOCTYPE html>
<html>
<head>
    <title>紧急修复 - 教师登录</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .step { margin: 15px 0; padding: 15px; border: 2px solid #ddd; border-radius: 5px; }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        button { margin: 5px; padding: 12px 20px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚨 紧急修复 - 教师登录问题</h1>
        
        <div class="step warning">
            <h3>⚠️ 问题诊断</h3>
            <p>您已经登录了，但是教师页面仍然要求登录。这通常是因为：</p>
            <ul>
                <li>JWT token没有正确保存到localStorage</li>
                <li>API请求没有包含Authorization头</li>
                <li>浏览器缓存了旧的JavaScript文件</li>
            </ul>
        </div>

        <div class="step">
            <h3>🔧 步骤1: 完全重置</h3>
            <button class="btn-danger" onclick="completeReset()">完全重置（清空所有数据）</button>
            <div id="resetResult"></div>
        </div>

        <div class="step">
            <h3>🔑 步骤2: 重新登录</h3>
            <button class="btn-success" onclick="emergencyLogin()">紧急登录（使用内置API）</button>
            <div id="loginResult"></div>
        </div>

        <div class="step">
            <h3>🧪 步骤3: 测试验证</h3>
            <button class="btn-primary" onclick="testEverything()">全面测试</button>
            <div id="testResult"></div>
        </div>

        <div class="step">
            <h3>🎯 步骤4: 访问教师页面</h3>
            <button class="btn-warning" onclick="openTeacherPage()">打开教师管理页面</button>
            <div id="accessResult"></div>
        </div>

        <div class="step">
            <h3>📋 实时日志</h3>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script>
        // 内置API客户端，不依赖外部文件
        class EmergencyAPI {
            constructor() {
                this.baseUrl = window.location.protocol + '//' + window.location.host;
                this.log('EmergencyAPI initialized');
            }
            
            log(message) {
                const logDiv = document.getElementById('debugLog');
                const timestamp = new Date().toLocaleTimeString();
                logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;
                console.log(message);
            }
            
            getHeaders() {
                const headers = { 'Content-Type': 'application/json' };
                const token = localStorage.getItem('access_token');
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                    this.log('✅ JWT token added to headers');
                } else {
                    this.log('❌ No JWT token found');
                }
                return headers;
            }
            
            async request(endpoint, options = {}) {
                const url = `${this.baseUrl}/api${endpoint}`;
                const config = {
                    headers: this.getHeaders(),
                    ...options
                };
                
                this.log(`Making request to: ${url}`);
                this.log(`Headers: ${JSON.stringify(config.headers)}`);
                
                try {
                    const response = await fetch(url, config);
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(`${response.status}: ${data.message || 'Request failed'}`);
                    }
                    
                    this.log(`✅ Request successful: ${response.status}`);
                    return data;
                } catch (error) {
                    this.log(`❌ Request failed: ${error.message}`);
                    throw error;
                }
            }
            
            async post(endpoint, body) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(body)
                });
            }
            
            async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            }
        }
        
        const api = new EmergencyAPI();
        
        function completeReset() {
            // 清空所有存储
            localStorage.clear();
            sessionStorage.clear();
            
            // 尝试清空cookies
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            
            // 清空缓存（尽力而为）
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(name) {
                        caches.delete(name);
                    });
                });
            }
            
            api.log('🗑️ Complete reset performed');
            document.getElementById('resetResult').innerHTML = 
                '<div class="success">✅ 已完全重置所有数据和缓存</div>';
        }
        
        async function emergencyLogin() {
            try {
                api.log('🔑 Starting emergency login...');
                
                const response = await api.post('/security/login', {
                    username: 'teacher1',
                    password: 'password123'
                });
                
                api.log(`Login response: ${JSON.stringify(response)}`);
                
                // 保存登录信息
                localStorage.setItem('access_token', response.access_token);
                localStorage.setItem('username', response.username);
                localStorage.setItem('user_role', response.role);
                localStorage.setItem('user_name', response.name);
                
                api.log('✅ Login successful, tokens saved');
                document.getElementById('loginResult').innerHTML = 
                    '<div class="success">✅ 紧急登录成功！Token已保存</div>';
                
            } catch (error) {
                api.log(`❌ Emergency login failed: ${error.message}`);
                document.getElementById('loginResult').innerHTML = 
                    '<div class="error">❌ 紧急登录失败: ' + error.message + '</div>';
            }
        }
        
        async function testEverything() {
            const results = [];
            
            // 检查存储
            const token = localStorage.getItem('access_token');
            const username = localStorage.getItem('username');
            const role = localStorage.getItem('user_role');
            
            results.push(`Token: ${token ? '✅ 存在' : '❌ 缺失'}`);
            results.push(`Username: ${username || '❌ 缺失'}`);
            results.push(`Role: ${role || '❌ 缺失'}`);
            
            // 测试API
            try {
                const polls = await api.get('/learning/polls/?course_id=COMP5241');
                results.push(`✅ API测试成功，返回${polls.length}个投票`);
            } catch (error) {
                results.push(`❌ API测试失败: ${error.message}`);
            }
            
            document.getElementById('testResult').innerHTML = 
                '<div class="' + (results.some(r => r.includes('❌')) ? 'error' : 'success') + '">' +
                results.join('<br>') + '</div>';
        }
        
        function openTeacherPage() {
            api.log('🎯 Opening teacher page...');
            window.open('teacher-activities.html', '_blank');
            document.getElementById('accessResult').innerHTML = 
                '<div class="warning">📚 教师页面已在新标签页打开，请检查是否正常显示</div>';
        }
        
        // 页面加载时自动检查状态
        window.addEventListener('load', function() {
            api.log('📋 Emergency fix page loaded');
            
            const token = localStorage.getItem('access_token');
            if (token) {
                api.log('🔍 Found existing token, testing...');
                testEverything();
            } else {
                api.log('⚠️ No token found, please complete reset and login');
            }
        });
    </script>
</body>
</html>
