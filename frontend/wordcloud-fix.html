<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <meta name="translate" content="no">
    <title>词云修复版本 - 支持中英文混合显示</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .wordcloud-container {
            min-height: 400px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .word-bubble {
            display: inline-block;
            margin: 8px;
            padding: 12px 20px;
            border-radius: 25px;
            color: white;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .word-bubble:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .word-bubble.english {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .word-bubble.chinese {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .word-bubble.mixed {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .word-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .stats-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: none;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 24px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: translateY(-3px) rotate(180deg);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }
        
        .no-translate {
            translate: no;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-4">
                    <h1 class="display-4 fw-bold text-primary">词云可视化 - 中英文混合显示</h1>
                    <p class="lead text-muted">实时显示学生提交的中文和英文词汇，无自动翻译</p>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 class="text-primary mb-0" id="total-count">0</h3>
                        <small class="text-muted">总词汇数</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 class="text-success mb-0" id="english-count">0</h3>
                        <small class="text-muted">英文词汇</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 class="text-info mb-0" id="chinese-count">0</h3>
                        <small class="text-muted">中文词汇</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h3 class="text-warning mb-0" id="unique-count">0</h3>
                        <small class="text-muted">唯一词汇</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-cloud"></i> 
                            词云可视化 
                            <small class="opacity-75">- 最后更新: <span id="last-update">未更新</span></small>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="wordcloud-container no-translate" id="wordcloud-display">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="text-muted">正在加载词云数据...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">词汇详细列表</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>词汇</th>
                                        <th>语言</th>
                                        <th>出现次数</th>
                                        <th>提交者</th>
                                        <th>最后提交时间</th>
                                    </tr>
                                </thead>
                                <tbody id="word-table">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">暂无数据</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button class="refresh-btn" onclick="loadWordCloudData()" title="刷新数据">
        <i class="bi bi-arrow-clockwise"></i>
    </button>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <script>
        const WORDCLOUD_ID = '68f1d0c27a93ac676124ea2d';
        
        // 检测词汇语言
        function detectLanguage(text) {
            const englishPattern = /^[a-zA-Z\s\-']+$/;
            const chinesePattern = /[\u4e00-\u9fff]/;
            
            if (englishPattern.test(text)) {
                return 'english';
            } else if (chinesePattern.test(text)) {
                return 'chinese';
            } else {
                return 'mixed';
            }
        }
        
        // 获取语言标签
        function getLanguageLabel(lang) {
            const labels = {
                'english': 'EN',
                'chinese': 'CN',
                'mixed': 'MIX'
            };
            return labels[lang] || 'UN';
        }
        
        // 获取词汇气泡的CSS类
        function getWordBubbleClass(lang) {
            return `word-bubble ${lang}`;
        }
        
        // 加载词云数据
        async function loadWordCloudData() {
            try {
                console.log('正在加载词云数据...');
                
                const response = await fetch(`/api/learning/wordclouds/${WORDCLOUD_ID}/results`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('词云数据:', data);
                
                displayWordCloud(data);
                updateStatistics(data);
                updateWordTable(data);
                
                // 更新时间戳
                document.getElementById('last-update').textContent = new Date().toLocaleString();
                
            } catch (error) {
                console.error('加载词云数据失败:', error);
                
                const container = document.getElementById('wordcloud-display');
                container.innerHTML = `
                    <div class="text-center py-5">
                        <div class="text-danger mb-3">
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                        </div>
                        <h5 class="text-danger">加载失败</h5>
                        <p class="text-muted">${error.message}</p>
                        <button class="btn btn-primary" onclick="loadWordCloudData()">重试</button>
                    </div>
                `;
            }
        }
        
        // 显示词云
        function displayWordCloud(data) {
            const container = document.getElementById('wordcloud-display');
            const words = data.words || [];
            
            if (words.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <div class="text-muted mb-3">
                            <i class="bi bi-cloud fs-1"></i>
                        </div>
                        <h5 class="text-muted">暂无词汇数据</h5>
                        <p class="text-muted">学生还没有提交任何词汇</p>
                    </div>
                `;
                return;
            }
            
            // 按出现次数排序
            words.sort((a, b) => b.value - a.value);
            
            let html = '';
            words.forEach(word => {
                const lang = detectLanguage(word.text);
                const className = getWordBubbleClass(lang);
                const langLabel = getLanguageLabel(lang);
                
                // 根据出现次数调整字体大小
                const maxCount = Math.max(...words.map(w => w.value));
                const minSize = 14;
                const maxSize = 32;
                const fontSize = minSize + ((word.value / maxCount) * (maxSize - minSize));
                
                html += `
                    <span class="${className} no-translate" 
                          style="font-size: ${fontSize}px;" 
                          title="${langLabel}: ${word.text} (${word.value}次)"
                          data-lang="${lang}"
                          data-count="${word.value}">
                        ${word.text}
                        ${word.value > 1 ? `<span class="word-count">${word.value}</span>` : ''}
                    </span>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 更新统计信息
        function updateStatistics(data) {
            const words = data.words || [];
            
            let englishCount = 0;
            let chineseCount = 0;
            let mixedCount = 0;
            
            words.forEach(word => {
                const lang = detectLanguage(word.text);
                if (lang === 'english') englishCount++;
                else if (lang === 'chinese') chineseCount++;
                else mixedCount++;
            });
            
            document.getElementById('total-count').textContent = words.length;
            document.getElementById('english-count').textContent = englishCount;
            document.getElementById('chinese-count').textContent = chineseCount;
            document.getElementById('unique-count').textContent = words.length;
        }
        
        // 更新词汇表格
        function updateWordTable(data) {
            const tbody = document.getElementById('word-table');
            const words = data.words || [];
            
            if (words.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暂无数据</td></tr>';
                return;
            }
            
            // 按出现次数排序
            words.sort((a, b) => b.value - a.value);
            
            let html = '';
            words.forEach(word => {
                const lang = detectLanguage(word.text);
                const langLabel = getLanguageLabel(lang);
                const langClass = lang === 'english' ? 'text-primary' : 
                                 lang === 'chinese' ? 'text-success' : 'text-info';
                
                html += `
                    <tr>
                        <td><span class="no-translate fw-bold">${word.text}</span></td>
                        <td><span class="badge bg-secondary ${langClass}">${langLabel}</span></td>
                        <td><span class="badge bg-primary">${word.value}</span></td>
                        <td class="text-muted">多个用户</td>
                        <td class="text-muted">刚刚</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // 页面加载时自动加载数据
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，开始加载词云数据');
            loadWordCloudData();
            
            // 每30秒自动刷新一次
            setInterval(loadWordCloudData, 30000);
        });
        
        // 禁用浏览器自动翻译
        document.documentElement.setAttribute('translate', 'no');
        document.documentElement.setAttribute('class', 'notranslate');
    </script>
</body>
</html>
